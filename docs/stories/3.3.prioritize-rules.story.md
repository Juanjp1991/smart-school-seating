# Story 3.3: Prioritize Placement Rules

## Status
✅ **READY FOR REVIEW**

## Story
**As a** teacher,
**I want** to be able to drag and re-order the rules in my list,
**so that** I can tell the system which rules are most important to follow.

## Acceptance Criteria
1. User can drag and drop rules to reorder them in the rule list
2. Rule priorities are automatically updated based on the new order (1 = highest priority)
3. Visual feedback shows which rule is being dragged and where it can be dropped
4. Priority changes are immediately saved to the database
5. The UI clearly shows the current priority order with visual indicators

## Tasks / Subtasks
- [x] Task 1: Implement drag-and-drop functionality in RuleList component (AC: 1, 3)
  - [x] Add drag-and-drop library integration (react-beautiful-dnd or similar)
  - [x] Implement onDragStart, onDragEnd handlers in RuleList
  - [x] Add visual feedback during drag operations
  - [x] Handle proper item reordering logic
- [x] Task 2: Update rule priority management (AC: 2, 4)
  - [x] Modify rule service to handle priority reordering
  - [x] Implement automatic priority reassignment after reorder
  - [x] Add database update operations for priority changes
  - [x] Handle optimistic updates for better user experience
- [x] Task 3: Enhance visual priority indicators (AC: 5)
  - [x] Add clear priority numbers/labels to rule items
  - [x] Implement priority-based visual styling (colors, badges)
  - [x] Add drag handles to rule items for better UX
  - [x] Ensure accessibility compliance for drag operations
- [x] Task 4: Error handling and validation (AC: 2, 4)
  - [x] Handle database errors during priority updates
  - [x] Implement rollback mechanism for failed operations
  - [x] Add loading states during priority updates
  - [x] Validate priority consistency after operations
- [x] Task 5: Testing and validation (AC: 1, 2, 3, 4, 5)
  - [x] Unit tests for drag-and-drop logic
  - [x] Integration tests for priority reordering
  - [x] Accessibility tests for drag operations
  - [x] Database consistency tests for priority updates

## Dev Notes

### Architecture Context
**Sprint 3: The Intelligent Placement Engine** [From PRD]:
- This story builds upon Stories 3.1 (Create Rule) and 3.2 (View Rules) to enable rule prioritization
- Establishes the foundation for Story 3.4 (Apply Rules) where priority order determines algorithm behavior
- Part of the placement rules epic that enables intelligent seating arrangements
- Critical for allowing teachers to express their rule preferences and constraints

### Previous Story Insights
From Story 3.2 (View Rules) completion:
- Rule display components are fully functional with filtering and search capabilities
- Database service patterns for rule operations are established and efficient
- User interface patterns for rule management are proven and working well
- Rule data model includes priority field that needs to be leveraged
- Visual hierarchy and status indicators are implemented and user-friendly
- Performance optimizations for rule operations are in place

From Story 3.1 (Create Rule) completion:
- Rule data model includes priority field as integer
- Database operations for rule CRUD are fully functional
- Rule validation and error handling patterns are established
- Modal-based workflows for rule management are proven effective

### Data Models
**Rule Interface with Priority Focus** [Source: docs/prd/4-data-models-in-indexeddb.md]:
```typescript
interface Rule {
  id: string
  roster_id: string
  priority: number  // 1 = highest priority, used for reordering
  type: 'SEPARATE' | 'TOGETHER' | 'FRONT_ROW' | 'BACK_ROW' | 'NEAR_TEACHER' | 'NEAR_DOOR'
  student_ids: string[]
  is_active: boolean
  created_at: Date
  updated_at: Date
}

// Priority management types
interface PriorityUpdate {
  ruleId: string
  newPriority: number
  oldPriority: number
}

interface DragResult {
  draggableId: string
  source: { index: number }
  destination: { index: number } | null
}
```

### Component Specifications
**Enhanced Rule List with Drag-and-Drop** [Source: docs/prd/2-uxui-flow-design-principles.md]:
```
┌─────────────────────────────────────────────────────────────┐
│                    Placement Rules                           │
├─────────────────────────────────────────────────────────────┤
│ Filter: [Active ▼] [All Types ▼] [Search Rules...]         │
│ Sort by: [Priority ▼] (disabled during drag)               │
│                                                             │
│ ⋮⋮ 1️⃣ 🟢 Must Not Sit Together                            │
│    Students: Sarah Adams, Michael Brown                     │
│    Created: Sep 6, 2025  •  [Edit] [Delete]               │
│                                                             │
│ ⋮⋮ 2️⃣ 🟡 Front Row Preference                             │
│    Students: Emily Davis, James Wilson                      │
│    Created: Sep 6, 2025  •  [Edit] [Delete]               │
│                                                             │
│ ⋮⋮ 3️⃣ 🔴 Must Sit Together (Inactive)                     │
│    Students: Alex Johnson, Sofia Martinez                   │
│    Created: Sep 6, 2025  •  [Edit] [Delete]               │
│                                                             │
│ [Create New Rule]                                          │
└─────────────────────────────────────────────────────────────┘
```

**Drag Feedback Visual Design**:
```
During Drag:
┌─────────────────────────────────────────────────────────────┐
│ 1️⃣ 🟢 Must Not Sit Together                               │
│ 2️⃣ ╭─────────────────────────────────────╮                │
│    │ DROP ZONE - Priority 2               │                │
│    ╰─────────────────────────────────────╯                │
│ 3️⃣ ┌─────────────────────────────────────┐ ← DRAGGING     │
│    │ 🟡 Front Row Preference              │                │
│    │ Students: Emily Davis, James Wilson   │                │
│    └─────────────────────────────────────┘                │
│ 4️⃣ 🔴 Must Sit Together (Inactive)                         │
└─────────────────────────────────────────────────────────────┘
```

### API Specifications
**Priority Management Service** [Source: docs/architecture/3-proposed-frontend-file-structure-reactnextjs.md]:
```typescript
// Enhanced rule service methods for priority management
interface RuleService {
  // Existing methods from previous stories
  createRule(rosterId: string, ruleData: Omit<Rule, 'id' | 'roster_id' | 'created_at' | 'updated_at'>): Promise<Rule>
  getRulesByRoster(rosterId: string): Promise<Rule[]>
  updateRule(ruleId: string, updates: Partial<Rule>): Promise<Rule>
  deleteRule(ruleId: string): Promise<void>
  
  // New methods for Story 3.3
  reorderRules(rosterId: string, reorderedRules: Rule[]): Promise<Rule[]>
  updateRulePriorities(priorityUpdates: PriorityUpdate[]): Promise<void>
  getMaxPriority(rosterId: string): Promise<number>
  validatePriorityConsistency(rosterId: string): Promise<boolean>
}
```

### File Locations
**Existing Files to Enhance:**
- `/components/rules/RuleList.tsx` - Add drag-and-drop functionality and priority management
- `/components/rules/RuleItem.tsx` - Add drag handles and enhanced priority display
- `/lib/ruleService.ts` - Add priority reordering and batch update methods
- `/types/rule.ts` - Add drag-and-drop related type definitions

**New Files to Create:**
- `/components/rules/DragDropContext.tsx` - Drag-and-drop wrapper component
- `/hooks/useDragAndDrop.ts` - Custom hook for drag-and-drop logic
- `/utils/priorityHelpers.ts` - Utility functions for priority calculations
- `/__tests__/components/rules/DragDropContext.test.tsx` - Drag-and-drop tests
- `/__tests__/hooks/useDragAndDrop.test.ts` - Hook tests
- `/__tests__/utils/priorityHelpers.test.ts` - Priority utility tests

**Files to Modify:**
- `/components/roster/RosterDetails.tsx` - Update to show priority information
- `/app/rosters/page.tsx` - Add state management for priority operations
- `/__tests__/lib/ruleService.test.ts` - Add priority management tests

### Testing Requirements
**Unit Testing Strategy**:
- Drag-and-drop component behavior with various scenarios
- Priority calculation and reordering logic
- Database update operations for priority changes
- Error handling during drag operations
- Accessibility compliance for drag-and-drop
- Performance testing with large rule lists

**Integration Testing Requirements:**
- Complete drag-and-drop workflow from start to finish
- Priority consistency across database operations
- Real-time updates and optimistic UI responses
- Error recovery and rollback mechanisms
- Cross-component integration with existing rule management

**E2E Testing Scenarios:**
- Full rule prioritization workflow
- Drag-and-drop operations across different screen sizes
- Keyboard accessibility for rule reordering
- Integration with existing rule creation and viewing features

### Technical Constraints
**Drag-and-Drop Library Requirements:**
- Must support accessible drag-and-drop operations
- Should work well with React/Next.js architecture
- Must handle touch devices for mobile support
- Should provide good visual feedback during operations

**Database Consistency:**
- Priority values must remain unique within each roster
- Priority gaps are allowed (1, 3, 5... is valid)
- All priority updates must be atomic transactions
- Rollback capability required for failed operations

**Performance Considerations:**
- Optimistic UI updates for smooth user experience
- Efficient batch updates for multiple priority changes
- Minimal re-renders during drag operations
- Proper debouncing for database updates

**Accessibility Requirements:**
- Keyboard navigation support for reordering
- Screen reader announcements for priority changes
- Focus management during drag operations
- Alternative input methods for reordering

### UI/UX Design Updates
**Enhanced Rule Item with Drag Handle**:
```
┌─────────────────────────────────────────────────────────────┐
│ ⋮⋮ 1️⃣ 🟢 Must Not Sit Together                           │
│ │  ├─────────────────────────────────────────────────────────┤
│ │  Students: Sarah Adams, Michael Brown                     │
│ │  Description: These students should not be seated adjacent│
│ │  to each other to minimize disruption                     │
│ │                                                           │
│ │  Created: Sep 6, 2025  •  Last Updated: Sep 6, 2025      │
│ │                                                           │
│ │  [✏️ Edit] [🗑️ Delete] [👁️ Preview]                   │
└─────────────────────────────────────────────────────────────┘
  ↑
Drag Handle
```

**Priority Status Bar**:
```
┌─────────────────────────────────────────────────────────────┐
│ Rule Priority: Highest → Lowest                             │
│ ████████████████████████████████████████████████████████    │
│ 3 Active Rules • Total: 4 Rules                           │
└─────────────────────────────────────────────────────────────┘
```

### Database Integration
**Priority Management Operations**:
```typescript
// Batch priority update for efficient reordering
interface BatchPriorityUpdate {
  ruleUpdates: { id: string; priority: number }[]
  rosterId: string
  timestamp: Date
}

// Database transaction for priority reordering
async function reorderRulePriorities(rosterId: string, newOrder: string[]): Promise<void> {
  const transaction = db.transaction(['rules'], 'readwrite')
  const store = transaction.objectStore('rules')
  
  try {
    for (let i = 0; i < newOrder.length; i++) {
      const ruleId = newOrder[i]
      const rule = await store.get(ruleId)
      if (rule && rule.roster_id === rosterId) {
        rule.priority = i + 1
        rule.updated_at = new Date()
        await store.put(rule)
      }
    }
    await transaction.complete
  } catch (error) {
    transaction.abort()
    throw new Error(`Failed to reorder rule priorities: ${error.message}`)
  }
}
```

### Error Handling Strategy
**Priority Management Error Scenarios:**
- Database transaction failures during reordering
- Network interruption during priority updates
- Concurrent modification conflicts
- Invalid drag-and-drop operations
- Priority consistency validation failures

**User Experience for Errors:**
- Immediate rollback to previous state on failure
- Clear error messages for failed operations
- Retry mechanism for network-related failures
- Visual feedback for processing states
- Graceful degradation when drag-and-drop unavailable

### Future Considerations
**Advanced Priority Features:**
- Rule grouping by priority levels (high, medium, low)
- Bulk priority operations for multiple rules
- Priority templates and presets
- Rule dependency management based on priorities

**Integration Planning:**
- Priority-based rule application in Story 3.4
- Priority visualization in seating plan generation
- Priority analytics and effectiveness tracking
- Priority-based rule conflict resolution

### Project Structure Notes
The current project structure aligns well with the proposed architecture:
- ✅ Component-based structure in `/components/rules/` directory supports drag-and-drop enhancement
- ✅ Service layer in `/lib/ruleService.ts` can be extended for priority management
- ✅ Type definitions in `/types/rule.ts` already include priority field
- ✅ Test files following established patterns can accommodate drag-and-drop testing
- ✅ Integration with existing roster management system is straightforward
- ✅ React/Next.js patterns support drag-and-drop libraries well

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-07 | 1.0 | Initial story creation for rule prioritization functionality | System |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Used TodoWrite tool to track all 5 main tasks through completion
- Implemented comprehensive error handling with retry mechanisms
- Added extensive validation for priority consistency
- Created full test coverage for all new functionality

### Completion Notes List
- ✅ Successfully integrated react-beautiful-dnd for drag-and-drop functionality
- ✅ Enhanced RuleList component with reorder mode toggle and visual feedback
- ✅ Implemented robust priority management with automatic reassignment
- ✅ Added comprehensive error handling with user-friendly error display
- ✅ Created priority utility functions with visual indicators and accessibility
- ✅ Built complete test suite covering all functionality
- ✅ All acceptance criteria met and validated through testing
- ✅ Build passes with only non-critical linting warnings

### File List
**New Files Created:**
- `/components/rules/DragDropContext.tsx` - Drag-and-drop wrapper component with visual feedback
- `/hooks/useDragAndDrop.ts` - Custom hook for drag-and-drop logic with error handling
- `/utils/priorityHelpers.ts` - Priority calculation and validation utilities
- `/__tests__/components/rules/DragDropContext.test.tsx` - Component tests
- `/__tests__/hooks/useDragAndDrop.test.ts` - Hook tests with comprehensive scenarios
- `/__tests__/utils/priorityHelpers.test.ts` - Utility function tests

**Files Modified:**
- `/components/rules/RuleList.tsx` - Added drag-and-drop integration, reorder mode, and error display
- `/components/rules/RuleItem.tsx` - Enhanced priority display with visual indicators and ordinal formatting
- `/lib/ruleService.ts` - Extended with priority management methods and validation
- `/package.json` - Added react-beautiful-dnd dependency and types

## QA Results
*To be populated during QA testing*