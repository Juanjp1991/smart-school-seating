# Story 1.2: Add Furniture

## Status
Ready for Review

## Story
**As a** teacher,
**I want** to place a teacher's desk (2 blocks) and a door (1 block) onto my grid layout,
**so that** the virtual classroom represents the key fixed elements of my physical room.

## Acceptance Criteria
1. User can select a "Teacher's Desk" tool.
2. The UI highlights two adjacent grid cells for placement.
3. User can rotate the desk highlight between horizontal and vertical.
4. User can click to place the desk on the grid.
5. User can select and place a one-block "Door" on the grid.
6. User can select a "Student Seat" tool and place seats by clicking on grid spaces.
7. Clicking an empty grid cell with seat tool selected turns it into a "seat".
8. Clicking a "seat" cell removes the seat (turns it back into an empty cell).

## Tasks / Subtasks
- [x] Task 1: Extend LayoutToolbar with furniture tools (AC: 1, 5, 6)
  - [x] Add "Teacher's Desk" tool button to toolbar
  - [x] Add "Door" tool button to toolbar
  - [x] Add "Student Seat" tool button to toolbar
  - [x] Add tool selection state management
  - [x] Style toolbar with new furniture tool buttons
- [x] Task 2: Implement desk placement with rotation (AC: 2, 3, 4)
  - [x] Create DeskPlacement component for 2-block furniture
  - [x] Implement horizontal/vertical rotation state
  - [x] Add rotation button to toolbar when desk tool selected
  - [x] Implement 2-cell highlight preview on grid hover
  - [x] Add collision detection for desk placement
- [x] Task 3: Implement door placement (AC: 5)
  - [x] Create single-cell furniture placement for doors
  - [x] Add door placement logic to grid click handler
  - [x] Style door cells differently from empty/seat cells
- [x] Task 4: Implement seat placement (AC: 6, 7, 8)
  - [x] Add seat placement logic to grid click handler
  - [x] Style seat cells with appropriate visual design
  - [x] Implement seat removal (click existing seat to remove)
  - [x] Handle seat-furniture collision appropriately
- [x] Task 5: Update grid state management (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [x] Extend grid state to handle furniture objects
  - [x] Update grid rendering to display furniture items
  - [x] Implement furniture removal (click placed furniture to remove)
  - [x] Update validation to prevent overlapping furniture
  - [x] Add seat state management and rendering
- [x] Task 6: Unit testing
  - [x] Test toolbar furniture tool selection
  - [x] Test desk rotation and placement validation
  - [x] Test door placement and removal
  - [x] Test furniture state management and collision detection
  - [x] Test grid rendering with furniture items
  - [x] Test seat placement and removal functionality

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Grid component is fully functional with responsive design (85% viewport width, 90% height)
- Layout editor page established at `/app/layout-editor/page.tsx`
- Grid state management working with input validation (1-20 range)
- All regression tests and linting passing - maintain this standard

### Data Models
**Layout Data Structure** [Source: architecture/4-data-models-in-indexeddb.md]:
- `layouts` store schema: `id`, `name`, `grid_rows`, `grid_cols`, `furniture` (JSON)
- This story focuses on populating the `furniture` field with desk and door objects
- Furniture objects should include: type, position(s), rotation for multi-cell items

**Suggested furniture object structure:**
```javascript
{
  type: 'desk' | 'door',
  positions: [{row: number, col: number}], // Array for multi-cell items
  rotation: 'horizontal' | 'vertical' // For desks
}
```

### API Specifications
**IndexedDB Integration** [Source: architecture/1-high-level-architecture.md, architecture/4-data-models-in-indexeddb.md]:
- Continue using local-first architecture with IndexedDB
- No backend API calls required for this story
- Database service at `/lib/db.js` needs extension for furniture persistence
- Update layout save/load functions to handle furniture data

### Component Specifications
**Layout Editor Components** [Source: architecture/2-uxui-flow-design-principles.md#21-screen-layout-editor]:
- Toolbar mockup shows: `[Rows: 8] [Cols: 6] | Tools: [Seat] [Desk] [Door] | [Rotate] | [Save]`
- Need to implement the [Desk] and [Door] tools in toolbar
- [Rotate] button should only appear when desk tool is selected
- Grid canvas must handle furniture item rendering and placement

**UI Design Requirements** [Source: architecture/2-uxui-flow-design-principles.md]:
- Maintain "Simplicity and Focus" principle - clean, intuitive interactions
- Toolbar on top design pattern established in Story 1.1
- Visual distinction needed between seats, desks, doors, and empty cells
- Desk placement requires hover preview showing 2-cell highlight

### File Locations
**File Structure** [Source: architecture/3-proposed-frontend-file-structure-reactnextjs.md]:
- Extend existing LayoutToolbar component: `/src/components/layout/LayoutToolbar.js`
- Extend existing Grid component: `/src/components/layout/Grid.js`
- Create FurnitureItem component: `/src/components/layout/FurnitureItem.js`
- Update layout editor page: `/src/app/layout-editor/page.js`

### Testing Requirements
**Testing Strategy** [Source: architecture/testing-strategy.md]:
No specific guidance found in architecture docs - follow established patterns from Story 1.1

### Technical Constraints
**Technology Stack** [Source: architecture/1-high-level-architecture.md]:
- React with Next.js framework (established)
- Local-first architecture (established)
- IndexedDB for data persistence (needs furniture support)
- Express server for static file serving only

**Existing Implementation Constraints:**
- Must maintain responsive design patterns from Story 1.1
- All tests must pass (12 unit tests + 7 E2E tests currently)
- Follow established TypeScript patterns
- Maintain ESLint compliance

### Testing
**Testing Standards:**
- Follow established Next.js/React testing patterns from Story 1.1
- Test file locations: `__tests__/components/layout/` and `__tests__/app/layout-editor/`
- Update existing test files to cover furniture functionality
- Add E2E tests for furniture placement and rotation in `e2e/layout-editor.spec.ts`
- Test furniture persistence with mock IndexedDB operations
- Ensure responsive design still works with furniture items
- Test accessibility for new toolbar buttons and furniture interactions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-06 | 1.0 | Initial story creation with furniture placement requirements | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Fixed webpack module bundler error by resolving circular import dependencies
- Moved shared types (FurnitureItem, ToolType, Rotation) to separate types.ts file
- Updated all import statements to use centralized type definitions

### Completion Notes List
- Successfully implemented comprehensive furniture placement system with desk, door, and seat tools
- Created LayoutToolbar component with proper tool selection and active state visualization
- Implemented 2-block desk placement with horizontal/vertical rotation capability  
- Added single-block door placement with immediate visual feedback
- Built robust collision detection preventing overlapping furniture and boundary violations
- Integrated hover preview system showing furniture placement before clicking
- Maintained responsive design patterns from Story 1.1 with enhanced grid interactions
- Added furniture removal capability (click existing furniture to remove)
- Implemented complete seat placement system with toggle functionality (click to add/remove)
- Added seat-furniture collision handling (seats can't be placed on furniture, furniture replaces seats)
- Enhanced CSS styling with distinct visual themes for desk, door, seat, and preview states
- Implemented comprehensive test suite: 22 unit tests + 16 E2E tests, all passing
- All acceptance criteria fully implemented with intuitive user interactions and visual feedback

### File List
**Modified Files:**
- `app/layout-editor/page.tsx` - Enhanced with furniture state management and LayoutToolbar integration
- `components/layout/Grid.tsx` - Extended with furniture placement, collision detection, and hover preview
- `app/globals.css` - Added CSS styles for furniture items, preview states, and enhanced toolbar buttons

**Created Files:**
- `components/layout/LayoutToolbar.tsx` - New toolbar component with furniture tool selection and rotation controls
- `components/layout/types.ts` - Centralized type definitions for furniture, tools, and rotation states
- `__tests__/components/layout/LayoutToolbar.test.tsx` - Comprehensive unit tests for toolbar functionality

**Updated Test Files:**
- `__tests__/components/layout/Grid.test.tsx` - Enhanced with furniture and seat rendering/interaction tests
- `__tests__/app/layout-editor/page.test.tsx` - Updated for new toolbar structure and functionality
- `e2e/layout-editor.spec.ts` - Extended with 9 new E2E tests for furniture/seat placement, collision handling, and boundary validation

## QA Results
*Results from QA Agent review will be populated here after implementation*