# Story 1.4: Save Layouts

## Status
Ready for Review

## Story
**As a** teacher,
**I want** to save a completed classroom layout as a named template,
**so that** I don't have to recreate it every time.

## Acceptance Criteria
1. A "Save" button exists in the layout editor toolbar.
2. Clicking "Save" prompts the user for a template name.
3. The layout, including grid dimensions, seats, and furniture, is saved locally using IndexedDB.
4. Saved layouts persist across browser sessions.
5. User receives feedback when a layout is successfully saved.
6. User can save multiple layouts with different names.
7. Attempting to save with an existing name prompts for confirmation to overwrite.

## Tasks / Subtasks
- [x] Task 1: Set up IndexedDB database service (AC: 3, 4)
  - [x] Create database service at `/lib/db.ts`
  - [x] Implement database initialization with `layouts` store
  - [x] Define layout data schema matching architecture requirements
  - [x] Add database connection and error handling
  - [x] Create helper functions for database operations
- [x] Task 2: Implement save layout functionality (AC: 2, 3, 5, 6, 7)
  - [x] Create save modal component for name input
  - [x] Implement layout serialization logic
  - [x] Add save operation with IndexedDB integration
  - [x] Implement duplicate name checking and confirmation
  - [x] Add success/error feedback notifications
- [x] Task 3: Update layout editor with save integration (AC: 1)
  - [x] Connect Save button to save functionality
  - [x] Update layout editor state management
  - [x] Handle save button states (loading, success, error)
  - [x] Ensure save captures all layout data accurately
- [x] Task 4: Unit and integration testing
  - [x] Test IndexedDB service operations
  - [x] Test save modal functionality and validation
  - [x] Test layout serialization and deserialization
  - [x] Test save workflow end-to-end
  - [x] Test error handling and edge cases
- [x] Task 5: E2E testing
  - [x] Test complete save workflow in browser
  - [x] Test layout persistence across sessions
  - [x] Test duplicate name handling
  - [x] Test save feedback and user notifications

## Dev Notes

### Previous Story Insights
From Stories 1.1-1.3 completion:
- Layout editor fully functional with Grid and LayoutToolbar components
- State management established: `rows`, `cols`, `furniture`, `seats`, `selectedTool`, `rotation`
- Current save handler is a placeholder console.log in `/app/layout-editor/page.tsx`
- All regression tests passing (22 unit tests + 16 E2E tests)
- TypeScript implementation with strong type safety maintained

### Data Models
**Layout Data Structure** [Source: architecture/4-data-models-in-indexeddb.md]:
- `layouts` store schema: `id`, `name`, `grid_rows`, `grid_cols`, `furniture` (JSON)
- This story implements the complete IndexedDB persistence layer
- Layout object structure:
```typescript
interface Layout {
  id: string          // UUID for unique identification
  name: string        // User-provided template name
  grid_rows: number   // From current rows state
  grid_cols: number   // From current cols state
  furniture: FurnitureItem[]  // From current furniture state
  seats: string[]     // From current seats state (converted from Set)
  created_at: Date    // Timestamp for creation
  updated_at: Date    // Timestamp for last modification
}
```

### API Specifications
**IndexedDB Integration** [Source: architecture/1-high-level-architecture.md]:
- Local-first architecture using IndexedDB for data persistence
- Database name: `SmartSchoolDB`
- Version: 1 (initial version for layouts store)
- No backend API calls required
- Database service located at `/lib/db.ts`
- Support for offline functionality and data portability

### Component Specifications
**Save Modal Design** [Source: architecture/2-uxui-flow-design-principles.md]:
- Follow "Simplicity and Focus" principle
- Modal should be clean and focused on name input
- Include validation for empty names and duplicate checking
- Provide clear feedback for save success/failure
- Follow established UI patterns from existing components

**Layout Editor Integration** [Source: architecture/2-uxui-flow-design-principles.md#21-screen-layout-editor]:
- Save button already exists in toolbar mockup: `[Save]`
- Maintain toolbar design consistency established in previous stories
- Ensure save operation doesn't disrupt user workflow
- Provide visual feedback during save process

### File Locations
**File Structure** [Source: architecture/3-proposed-frontend-file-structure-reactnextjs.md]:
- Database service: `/lib/db.ts` (new)
- Save modal component: `/components/common/SaveModal.tsx` (new)
- Update layout editor: `/app/layout-editor/page.tsx` (existing)
- Update toolbar: `/components/layout/LayoutToolbar.tsx` (existing)
- Type definitions: `/components/layout/types.ts` (extend)

### Testing Requirements
**Testing Strategy**:
- Follow established patterns from Stories 1.1-1.3
- Mock IndexedDB for unit tests using fake-indexeddb library
- Test file locations: `__tests__/lib/` for database tests
- Update existing test files for save integration
- Add E2E tests for complete save workflow
- Test error scenarios: storage full, permission denied, etc.
- Ensure all existing tests continue to pass

### Technical Constraints
**Technology Stack** [Source: architecture/1-high-level-architecture.md]:
- React with Next.js framework (TypeScript)
- IndexedDB for local data persistence
- No external dependencies for database operations
- Must maintain responsive design
- Follow existing ESLint and TypeScript configurations

**Implementation Requirements**:
- Use modern async/await pattern for IndexedDB operations
- Implement proper error handling and user feedback
- Ensure data integrity and validation
- Support concurrent saves (if user clicks save multiple times)
- Maintain backward compatibility with existing layout data

**Security Considerations**:
- Validate all user inputs (layout names, data structures)
- Handle IndexedDB storage limitations gracefully
- Ensure no data leakage between different users on shared devices
- Implement proper data serialization/deserialization

### Integration Points
**Current State Management**:
- Layout data is currently in React component state
- Need to serialize: `rows`, `cols`, `furniture` (FurnitureItem[]), `seats` (Set<string>)
- Convert seats from Set to Array for JSON storage
- Generate UUID for layout identification

**User Experience Flow**:
1. User clicks Save button in toolbar
2. Save modal opens with name input field
3. User enters template name and confirms
4. Layout data is serialized and saved to IndexedDB
5. Success notification appears
6. Modal closes and user can continue editing

### Performance Considerations
- IndexedDB operations should be asynchronous to avoid blocking UI
- Implement debouncing if rapid save clicks are possible
- Consider layout data size limits and optimization
- Cache recent layouts for improved performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-06 | 1.0 | Initial story creation for save layouts functionality | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Implemented IndexedDB database service with comprehensive error handling and connection management
- Created SaveModal component with form validation, loading states, and duplicate name confirmation
- Added Notification component with auto-dismiss functionality and success/error states
- Fixed structuredClone polyfill requirement for fake-indexeddb testing environment
- Resolved ESLint HTML entity escaping requirements for user-facing strings

### Completion Notes List
- Successfully implemented complete IndexedDB persistence layer with `SmartSchoolDB` database
- Created robust save modal workflow with name validation, duplicate checking, and overwrite confirmation
- Integrated save functionality seamlessly with existing layout editor without disrupting user workflow
- Implemented comprehensive notification system for user feedback with proper UX timing
- Built complete layout serialization supporting grid dimensions, furniture items, and seat placements
- Added extensive unit test coverage for all new components with 38+ test cases
- Extended E2E test suite with 9 new tests covering complete save workflow scenarios
- All acceptance criteria exceeded: save button, name prompts, IndexedDB persistence, feedback, and duplicate handling
- Maintained responsive design and accessibility standards throughout implementation
- Code passes all linting checks and follows established TypeScript patterns

### File List
**Created Files:**
- `lib/db.ts` - IndexedDB database service with full CRUD operations and schema management
- `components/common/SaveModal.tsx` - Modal component for layout name input with validation and error handling
- `components/common/Notification.tsx` - Notification system for user feedback with auto-dismiss
- `__tests__/lib/db.test.ts` - Comprehensive database service unit tests (12 test cases)
- `__tests__/components/common/SaveModal.test.tsx` - Save modal component tests (18 test cases)
- `__tests__/components/common/Notification.test.tsx` - Notification component tests (17 test cases)

**Modified Files:**
- `app/layout-editor/page.tsx` - Integrated save functionality with state management and modal/notification components
- `app/globals.css` - Added comprehensive CSS styling for modal overlay, notification system, and form elements
- `jest.setup.js` - Added structuredClone polyfill for fake-indexeddb compatibility
- `package.json` - Added fake-indexeddb dependency for testing
- `__tests__/app/layout-editor/page.test.tsx` - Extended with save functionality tests (7 additional test cases)
- `e2e/layout-editor.spec.ts` - Added 9 new E2E tests for complete save workflow validation

**Enhanced Test Coverage:**
- Unit tests: 38+ test cases across database service, modal, and notification components
- E2E tests: 9 new tests covering save modal, validation, success/error handling, and state persistence
- Integration tests: Layout editor save workflow with mock database operations
- All tests verify proper error handling, user feedback, and data persistence

## QA Results
*Results from QA Agent review will be populated here after implementation*